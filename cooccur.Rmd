---
title: "plot cooccurrences"
output: html_document
date: "2023-06-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cooccur)
library(ggplot2)
library(tidyverse)
library(dggridR)
library(dplyr)
library(radiant.data)
```


```{r}
all_birds <- readRDS("data_2023/df_nvector_2023.rds")
all_birds <- all_birds %>% filter(year == 2022)
```


```{r}
n = nrow(all_birds)

#weights all together
weight <- all_birds %>%
    mutate(day = as.numeric(day),
         year = as.numeric(year)) %>%
group_by(species, year, day) %>%
  summarise(
            numcells = n(), 
            numobs = sum(count),
            wtmean_lon = weighted.mean(x, count/effort), 
            wtmean_lat = weighted.mean(y, count/effort), 
            wtsd_lon = weighted.sd(x, count/effort),
            wtsd_lat = weighted.sd(y, count/effort) 
            ) %>%
  ungroup()

weight <- weight %>%
  mutate(DAYm1 = day-1,
         origin = paste0(year, "-01-01"),
         DATE = as.Date(DAYm1, origin=origin), 
         MONTH = month(DATE)) %>%
  mutate(winter = ifelse(MONTH %in% c(10, 11, 12, 1, 2, 3), "winter", "non-winter")) %>%
  arrange(species,DATE) %>%
  ungroup() %>%
  mutate(ID = row_number()) %>%
  dplyr::select(-DAYm1, -origin)

## Calculates the count of observations within each cell, 
#weighted by total eBirder effort on that day in a given cell. 
#Appends into the dataframe as "count_weighted" for analysis. Weighted as the total number of observations of the #target species in a cell divided by the total number of eBirder records in a cell.

dgg <- dgconstruct(project = "FULLER", aperture = 4, topology = "HEXAGON", res = 5)
all_birds$cell <- dgGEO_to_SEQNUM(dgg, all_birds$x, all_birds$y)$seqnum
all_birds$cell_lat <- dgSEQNUM_to_GEO(dgg, all_birds$cell)$lat_deg 
all_birds$cell_lon <- dgSEQNUM_to_GEO(dgg, all_birds$cell)$lon_deg 

#already has frequency column which is count/effort
all_birds <- all_birds %>%
  mutate(count_weighted = count/effort)

spp_counts <- all_birds %>%
  group_by(species, cell) %>% 
  summarise(sum_weighted_count=sum(count_weighted),
            mean_weighted_count=mean(count_weighted),
            sum_count=sum(count))

#Get the grid cell boundaries for cells which had bird observations
grid <- dgcellstogrid(dgg, spp_counts$cell)#, frame=TRUE, wrapcells=TRUE)
#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, spp_counts, by.x="seqnum", by.y="cell")
```


```{r}
#wrangling data to make it usable with cooccur package
species_list <- unique(weight$species)
poly_list <- unique(as.character(grid$seqnum))

occur_df <- data.frame(species = species_list)

for (p in poly_list){
  occur_df <- occur_df %>%
  add_column(p = NA)
}

occur_df <- occur_df %>% column_to_rownames(., var = "species")
colnames(occur_df) <- poly_list


for (i in 1:length(species_list)){
  spec_df <- grid[grid$species == species_list[i], ]
  for (p in 1:length(poly_list)){
    #if species was found in a given polygon, give it a value of 1
    if (poly_list[p] %in% spec_df$seqnum){
      occur_df[[p]][[i]] <- 1
    }
    #otherwise, give it a value of 0
    else{
      occur_df[[p]][[i]] <- 0
    }
  }
}

#starting doing this but ended up doing it the above way instead
#figured I would keep this for now, might be useful later
#occur_df$"443"[[3]] <- 10

#for (s1 in species_list){
#  spec_df1 <- grid[grid$species == s1, ]
#  for (s2 in species_list){
#    num_cells = 0
#    spec_df2 <- grid[grid$species == s2, ]
    
#    for (p in poly_list){
#      if (p %in% spec_df1$seqnum){
#        if (p %in% spec_df2$seqnum){
#          num_cells = num_cells + 1
#        }
#      }
#    }
#  }
#}
```


```{r}
cooccur_birds <- cooccur(occur_df, type = "spp_site", thresh = FALSE, spp_names = TRUE)

summary(cooccur_birds)
```



```{r}
#sp1_inc and sp2_inc represent number of polygons the bird appeared in 
#p_lt and p_gt are the probabilities that the two species co-occur more or less frequently than expected.
prob_table <- prob.table(cooccur_birds)
```


```{r}
#was not expecting so many pairs species to have positive co-occurrence 
#might change when I limit to ERC range and when we get data at res = 6
plot(cooccur_birds)
```


```{r}
waxwing_pairs <- pair(mod = cooccur_birds, spp = "Bombycilla cedrorum")
```



