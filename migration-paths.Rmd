---
title: "Migration-path.Rmd"
author: "Sarah Supp"
date: "2/10/2020"
output: html_document
---

##Code for cedar waxwing project, modified from eBird migration project (Supp et al. 2015)
(c) 2020, Niu and Supp


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggmap)
library(maptools)
library(fields)
library(sp)
library(raster)
library(maps)
library(mapdata)
library(rgdal)
library(raster)
library(gamm4)
library(tidyverse)
library(dplyr)
#library(SDMTools)#FIXME: package ‘SDMTools’ is not available (for R version 3.6.2)
library(dggridR)
library(geojsonio)
library(RColorBrewer)
library(geosphere)
library(mgcv)
library(radiant.data)
#load("data/Bombycilla_cedrorum.RData")
#load("data/effort.Rdata")
#load("data/locs.Rdata")
load("data/dat_effort.RData")
```

We need to decide if we look at migration for ALL cewa, or just for eastern flyway (103 Longitude and east). Maybe do it both ways and compare?


## merge locs with Bombycilla on POLYFID
```{r}
#TODO: example code you could modify or test from old code (feel free to delete when done)  
#merge data on POLYFID so it includes the center of each hex cell (LONGITUDE.y, LATITUDE.y)

dat_merged = merge(ebrd2.c, locs, by.x = "POLYFID", by.y = "POLYFID")

```

## Weight Bombycilla counts by eBirder 
effort counts  
```{r} 
#TODO Supp get starter code from hb project - we used the wt.mean function before, from SDMTools package. You can find example in "migration-fxns.r" in the function written for AlternateMeanLocs (see also the code chunk below for Estimate migration pathway)

dat_effort = merge(dat_merged, eft.c, by.x = c("POLYFID", "YEAR", "DAY"), by.y = c("POLYFID","YEAR",  "DAY"))
#save(dat_effort, file = "data/dat_effort.RData")


weighted_mean_locs <- dat_effort %>%
group_by(YEAR, DAY) %>%
  summarise(
            numcells = n(), 
            numobs = sum(count.x),
            wtmean_lon = weighted.mean(lon, count.x/count.y), 
            wtmean_lat = weighted.mean(lat, count.x/count.y) 
            #wtsd_lon <- weighted.sd(lon, count.x/count.y),
            #wtsd_lon <- weighted.sd(lat, count.x/count.y) FIXME: weighted standard deviation
            )
```


Initial plot of bird average locations for cedar waxwing species and latitude by day across years
```{r}
ggplot(weighted_mean_locs, aes(wtmean_lon, wtmean_lat)) +
  geom_point(alpha=0.25) + geom_line(alpha=0.25) +
  facet_wrap(~YEAR)

ggplot(weighted_mean_locs, aes(DAY, wtmean_lat, group=YEAR)) +
  geom_point(alpha=0.25) + geom_line(alpha=0.25) +
  facet_wrap(~YEAR)
```



```{r}
dgg <- dgconstruct(project = "FULLER", aperture = 4, topology = "HEXAGON", res = 6)
dat_effort$cell <- dgGEO_to_SEQNUM(dgg, dat_effort$lon, dat_effort$lat)$seqnum
dat_effort$cell_lat <- dgSEQNUM_to_GEO(dgg, dat_effort$cell)$lat_deg 
dat_effort$cell_lon <- dgSEQNUM_to_GEO(dgg, dat_effort$cell)$lon_deg 

dat_effort <- dat_effort %>%
  mutate(count_weighted = count.x/count.y)


#cellcenters   <- dgSEQNUM_to_GEO(dgg, dat_effort$cell)
cewa_counts <- dat_effort %>%
  group_by(cell) %>% 
  summarise(count_new=sum(count_weighted))

ggplot(cewa_counts, aes(x=count_new)) + geom_histogram(binwidth=10)
```


## Create a map of eBird effort (all years, all dates)


```{r}
#TODO: You can come up with your own methods for making a map (there are SO many), and/or you can use #       the code from "hb-migration.r" and "migration-fxns.r" as a starting point for ideas.

#Get the grid cell boundaries for cells which had bird observations
grid <- dgcellstogrid(dgg, cewa_counts$cell, frame=TRUE, wrapcells=TRUE)

#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, cewa_counts, by.x="cell", by.y="cell")
#Get polygons for the spatial range and make a map of bird observations
countries <- map_data("usa") 

ggplot() + 
  #geom_polygon(data=countries, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  geom_polygon(data=grid,      aes(x=long, y=lat, group=cell, fill=count_new), alpha=0.4)    +
  
  
  geom_path   (data=grid,      aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
#  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
  scale_fill_gradient2(low="blue", high="red", midpoint = 250)


```


## Create a map of Bombycilla counts (all years, all dates)

```{r}
#TODO: Make how you prefer, but feel free to plot the data as the actual locations of the birds 
#       (from the .csv files), or to use the .Rdata files to plot the polygon center, maybe with 
#       point sized or colored by magnitude of the count.
all_states <- map_data("state")
#states <- subset(all_states, region %in% c('ohio', 'michigan', 'kentucky', 'tennessee', 'indiana', 
#                                           'illinois', 'iowa', 'nebraska','south dakota', 'north dakota',
#                                           'minnesota', 'wisconsin', 'missouri', 'kansas'))
uw_cewa_counts <- dat_effort %>%
  group_by(cell) %>% 
  summarise(count_new_uw=sum(count.x))
uw_grid <- dgcellstogrid(dgg, uw_cewa_counts$cell, frame=TRUE, wrapcells=TRUE)

uw_grid <- merge(grid, uw_cewa_counts, by.x="cell", by.y="cell")

p <- ggplot() +
  geom_polygon( data=all_states, aes(x=long, y=lat, group = group), colour="black", fill="white" ) +
  geom_polygon(data=uw_grid,      aes(x=long, y=lat, group=cell, fill=count_new_uw), alpha=0.4)    +
  
  geom_path   (data=uw_grid,      aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
#  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
  scale_fill_gradient2(low="blue", high="red",midpoint = 10000 )
  labs(title="Cedar Waxwing locations") + 
  theme_bw() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
p


```


## Estimate migration pathway for Bombycilla each year separately
```{r}
#TODO: use or modify code from "migration-fxns.r" file, AlternateMeanLocs
#       that method used a loop to go through each year separately, 
#       but could probably be written using dplyr or apply (purr??) to simplify and optimize
#       I'm sure there's a more elegant way to do it. Basically, we need to calculate a weighted mean
#       for longitue and latitude, separately. We could use the wt.mean function (pkg=SDMTools), and #       the weight would be the cedarwaxwing count/total ebirder count from each row in the merged 
#       Bombycilla-effort dataset. I wrote the referenced code before I became a tidyverse user. 
#       for example: wt.mean(mergedata$Longitude, mergedata$BombycillaCount/mergedata$ebirdCount)



```

```{r}
daily_travel <- weighted_mean_locs %>%
  arrange(DAY) %>%
  mutate(distance = distVincentyEllipsoid(wtmean_lon, wtmean_lat)) %>% 
  filter(DAY >= migration_dates$spring_begin & migration_dates <= migration_dates$autumn_end)
#FIXME: error in distVincentyEllipsoid()
ggplot(daily_travel, aes(DAY, distance)) + geom_line(size=1, col = "#4daf4a") + 
  theme_bw() + xlab("Julian Day") + ylab("Distance Traveled (km)") + 
  ggtitle(paste(species, year, sep = " ")) + theme(text = element_text(size=20)) +  
  geom_vline(xintercept = median(migr_dates), col = "indianred", linetype = "dashed")
```

## Use GAM model to predict daily location along a smoothing line, from the weighted mean locations
```{r}
#TODO: Modify and update code from "migration-fxns.r" file, for EstimateDailyLocs. 
#       Takes the new mean locations as input and outputs the smoothed migration path day by day.
#       Can also see implemented in hb-migration.r: preds = EstimateDailyLocs(meanlocs)

```


# estimate 3 migration dates, beginning of spring, peak latitude (summer), end of fall migration
```{r}
# TODO: from old function Est3MigrationDates in migration-fxns

```

