---
title: "Migration-path.Rmd"
author: "Sarah Supp"
date: "2/10/2020"
output: html_document
---

# INTRODUCTION

## Code for cedar waxwing project, modified from eBird migration project (Supp et al. 2015)
(c) 2020-2023, Niu, Lee, Wisnefski, and Supp (PI)
supps@denison.edu
Denison University
Code is under development, part of NSF Multi-Institution Collaborative Award (2019-2025)
modified from previous code developed for Supp et al. 2015 hummingbird paper (Ecosphere)

Birds evaluated include: 
* Cedar Waxwing (CEWA) _Bombycilla cedrorum_
* Robin (ROBI) _Turdus migratorius_
* Wood Thrush (WOTH) _Hylocichla mustelina_
* Yellow-rumped Warbler (YEWA) _setophaga coronata_
* Blue Jay (BLJA) _Cyanocitta cristata_
* European Starling (EUST) _Sturnus vulgaris_
* Eastern Bluebird (EABL) _Sialia sialis_
* Northern Mockingbird (NOMO) _Mimus polyglottos_
* Downy Woodpecker (DOWO) _Dryobates pubescens_
* Eastern Meadowlark (EAME) _Sturnella magna_
* White-breasted Nuthatch (WHNU) _Sitta carolinensis_
* Purple Finch (PUFI) _Haemorhous purpureus_
* Northern Cardinal (NOCA) _Cardinalis cardinalis_
* Dark-eyed Junco (DAJU) _Junco hyemalis_
* American Crow (AMCR) _Corvus brachyrhynchos_


##FIXME: check which of these libraries is  used, and remove ones that are not needed
```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(broom)
#library(data.table) #FIXME: check, but I don't think this is used, remove if not
#library(devtools)
#devtools::install_github('r-barnes/dggridR', vignette=TRUE, force = TRUE)
library(dggridR)
library(fields) #FIXME: Test if this is needed or already loaded in background with sf or sp
library(gamm4) 
#library(gapminder)
#library(geojsonio) #FIXME: Test if this is needed. Delete if not.
#devtools::install_github("dkahle/ggmap")
library(ggmap)
library(ggpubr)
#library(kableExtra)
library(lubridate)
#library(maps) #FIXME: Test if these are needed or already loaded in background with ggplot2 and ggmap
#library(mapdata) #FIXME: remove if not needed
library(mgcv)
library(maptools)
library(purrr)
#library(radiant.data)
#library(raster) FIXME: Check if I need to load this; may not if relying mainly on sf and not manipulating raster datasets directly.
library(RColorBrewer)
library(rnaturalearth) 
#FIXME: do I need both naturalearth packages?
#devtools::install_github("ropensci/rnaturalearthhires")
#library(rnaturalearthhires) #is this just a higher resolution version of rnaturalearth?
#devtools::install_github("r-spatial/sf") #C compiler error on mac
library(sf)
#library(sjPlot)
#library(sjmisc)
#library(sjlabelled)
library(stargazer)
#library(sp) #FIXME: This would be the "old" way of handling spatial data; not as compatible with tidyvers. Test and remove if not needed, in favor of keeping sf only.
```

For this code chunk, you need to already have processed the raw eBird data files (process-raw-eBird-data.Rmd) and generated the daily centroids using the nvector method and weighted means (daily-nvector-centroids.Rmd). If you have not yet run these steps or generated the .rds output files, please go back and run those two files in that order first. The files are listed below, so you can check if they exist in the folder structor before proceeding.

Species files from *process-raw-eBird-data.Rmd*: 
* dat_effort_Bombycilla cedrorum.rds
* dat_effort_Cardinalis cardinalis.rds
* dat_effort_Corvus brachyrhynchos.rds
* dat_effort_Cyanocitta cristata.rds
* dat_effort_Dryobates pubescens.rds
* dat_effort_Haemorhous purpureus.rds
* dat_effort_Hylocichla mustelina.rds
* dat_effort_Junco hyemalis.rds
* dat_effort_Mimus polyglottos.rds
* dat_effort_Setophaga coronata.rds
* dat_effort_Sialia sialis.rds
* dat_effort_Sitta carolinensis.rds
* dat_effort_Sturnella magna.rds
* dat_effort_Sturnus vulgaris.rds
* dat_effort_Turdus migratorius.rds 

Files from *daily-nvector-centroids.Rmd*:
- dat_effort_2023.rds
- df_nvector_2023.rds
- weighted_mean_locs_2023.rds

**Note:** dat_effort and the weighted mean files have already been **filtered to the eastern flyway**. [La Sorte et al. 2014](https://onlinelibrary.wiley.com/doi/full/10.1111/jbi.12328) defined western, central, and eastern flyways for migrating songbirds. These are general, but since our species include populations across the continent, and we are focused on eastern and midwestern populations of eastern redcedar, and use processed data that excludes western occurrences (<-103 longitude). *If you want to include occurrences from broader locations, will need to use the individual species files that are generated by the process-eBird-data.Rmd file and brought in at the beginning of the code in daily-nvector-centroids.Rmd to make the merged spdata dataframe.*


# Load the processed data 
#### Includes files for: merged species, nvector locations, and the weighted mean daily centroids
These files are generated by the code "daily-nvector-centroid.Rmd".

Loads the processed data
```{r}
# #Loading RDS file 
dat_effort <- readRDS("data_2023/dat_effort_2023.rds")
df <- readRDS("data_2023/df_nvector_2023.rds") #FIXME: Give this a better name? Would need to replace downstream.
weighted_mean_locs <- readRDS("weighted_mean_locs_2023.rds")
```

# Data summaries for manuscript and annual reporting
##START HERE
Count number of records by year *for 2020 NSF report*
```{r}
#count total number of records across the years. (increasing strongly)
counts <- df %>%
  group_by(species, year) %>%
  tally()

num_bins <- ggplot(counts, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of binned observations") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

#checking how many unique grid cells logged an observation in each year (relatively flat)
nPOLYFID <- df %>%
  group_by(species, year) %>%
  summarise(n=n_distinct(POLYFID))

num_gridcells <- ggplot(nPOLYFID, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of unique grid cells") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

#checking how many days per year have at least 1 observation (ALL of them)
nDAYSofyear <- df %>%
  group_by(species, year) %>%
  summarise(n=n_distinct(day))

num_days <- ggplot(nDAYSofyear, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of unique days per year") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

ggarrange(num_bins, num_gridcells, num_days,
          labels=c("A", "B", "C"),
          ncol=3, nrow=1)

ggsave(filename = "figs/species_obs_2023.png", height = 11, width=8)
```


Initial plot of bird average locations for all species and latitude by day across years *for 2020 NSF report*
```{r}
wtlon_by_day <- ggplot(weighted_mean_locs, aes(day, weighted_lon, group=year)) +
  geom_point(alpha=0.25, aes(col=winter)) + geom_line(alpha=0.25) +
  facet_wrap(~year)

wtlat_by_day <- ggplot(weighted_mean_locs, aes(as.numeric(day), weighted_lat, group=year)) +
  stat_smooth(aes(col=as.numeric(year))) + ylab("Weighted mean latitude") +
  xlab("Day of the year") + 
  scale_x_continuous(breaks = seq(1, 366, by = 60)) +
  facet_wrap(~species)

ggsave(wtlat_by_day, filename = "figs/15species_weighted_mean_locs_smmooth_2023.png", height = 11, width=8)
```


## Calculates the count of observations within each cell, 
weighted by total eBirder effort on that day in a given cell. 
Appends into the dataframe as "count_weighted" for analysis. Weighted as the total number of observations of the target species in a cell divided by the total number of eBirder records in a cell.

```{r}
#using original data(dat_effort=df)
dgg <- dgconstruct(project = "FULLER", aperture = 4, topology = "HEXAGON", res = 6)
df$cell <- dgGEO_to_SEQNUM(dgg, df$x, df$y)$seqnum
df$cell_lat <- dgSEQNUM_to_GEO(dgg, df$cell)$lat_deg 
df$cell_lon <- dgSEQNUM_to_GEO(dgg, df$cell)$lon_deg 

#cellcenters   <- dgSEQNUM_to_GEO(dgg, dat_effort$cell)
spp_counts <- df %>%
  group_by(species, cell) %>% 
  summarise(sum_weighted_count=sum(freq),
            mean_weighted_count=mean(freq),
            sum_count=sum(count))

ggplot(spp_counts, aes(x=mean_weighted_count)) +
  geom_histogram(binwidth=0.01) + 
  facet_wrap(~species)

```


## Create a map of eBird effort (all years, all dates)
across eastern North America

TODO: Need to update the code (see: https://github.com/r-barnes/dggridR/blob/master/vignettes/dggridR.Rmd). 
FIXME: After merging grid and spp_counts, long and lat are gone. 

```{r}
#Get the grid cell boundaries for cells which had bird observations
#FIXME: after merging grid and spp_count, there are no longer a long and lat  

#grid <-  dggridR::dgcellstogrid(dgg, spp_counts$cell, frame=TRUE, wrapcells=TRUE) #->not working 
grid <- dggridR::dgcellstogrid(dgg, spp_counts$cell) 


#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, spp_counts, by.x="seqnum", by.y="cell")
# grid <- merge(grid, spp_counts, by="cell")
# grid <- merge(grid, spp_counts, by.x="cell", by.y="cell")

#Make adjustments so the output is more visually interesting
# grid$count    <- log(grid$sum_count)
# cutoff        <- quantile(grid$count,0.9)
# grid          <- grid %>% mutate(count=ifelse(count>cutoff,cutoff,count))

#zoom to just eastern USA
grid <- grid %>%
  filter(long >= -103,
         lat >= 25)
#Get polygons for the spatial range and make a map of bird observations
countries <- map_data("usa") 


ggplot() + 
  geom_polygon(data=countries, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  geom_sf(data = grid, aes(fill = sum_count), color = alpha("white", 0.4 )) +
  scale_fill_gradient(low="gray90", high="black") +
  theme_bw() + 
  facet_wrap(~species)
 
# Dr. Supp old codes
#   #geom_polygon(data=grid, aes(x=long, y=lat, group=cell, fill=mean_weighted_count), alpha=0.4)    +
#   geom_path   (data=grid, aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
# #  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
#   scale_fill_gradient(low="gray90", high="black") + 
#   #scale_fill_gradient2(low="blue", high="red", midpoint = 250) 
#   theme_bw() + 
#   facet_wrap(~species)

# ggplot() + 
#   #geom_polygon(data=countries, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
#   geom_polygon(data=grid, aes(x=long, y=lat, group=cell, fill=mean_weighted_count), alpha=0.4)    +
#   geom_path   (data=grid, aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
# #  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
#   scale_fill_gradient(low="gray90", high="black") + 
#   #scale_fill_gradient2(low="blue", high="red", midpoint = 250) 
#   theme_bw() + 
#   facet_wrap(~species)
```


## Create a map of species counts (all years, all dates)
across eastern North America

TODO: Needs to update the code. (see: https://github.com/r-barnes/dggridR/blob/master/vignettes/dggridR.Rmd). 
FIXME: After merging grid and uw_spp_counts, cell is gone. Only sequem and geometry are shown. 

```{r}
#TODO: Make how you prefer, but feel free to plot the data as the actual locations of the birds 
#       (from the .csv files), or to use the .Rdata files to plot the polygon center, maybe with 
#       point sized or colored by magnitude of the count.


#all_states <- map_data("state")
state_prov <- rnaturalearth::ne_states(c("united states of america", "canada"))
#states <- subset(all_states, region %in% c('ohio', 'michigan', 'kentucky', 'tennessee', 'indiana', 
#                                           'illinois', 'iowa', 'nebraska','south dakota', 'north dakota',
#                                           'minnesota', 'wisconsin', 'missouri', 'kansas'))
uw_spp_counts <- df %>%
  group_by(species, cell) %>% 
  summarise(count_new_uw=sum(count))



uw_grid <- dgcellstogrid(dgg, uw_spp_counts$cell)
uw_grid <- merge(grid, uw_spp_counts, by.x=c("cell", "species"), by.y=c("cell", "species")) 

p <- ggplot() +
  geom_polygon(data=state_prov, 
                aes(x=long, y=lat, group = group), colour="black", fill="white") +
  geom_polygon(data=uw_grid, 
               aes(x=long, y=lat, group=cell, fill=count_new_uw), alpha=0.4) +
  geom_path(data=uw_grid, 
            aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
  xlim(-102,-52) +
#  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
  scale_fill_gradient(low="red", high="yellow") +
#  scale_fill_gradient2(low="blue", high="red",midpoint = 10000 ) +
  labs(title="Bird locations") + 
  theme_bw() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
  facet_wrap(~species)
p
```

# Estimate migration pathways using Generalized Additive Model, population-level migration speed, and migration dates

## Estimate migration pathway for 15 species each year separately using GAMs
Use GAM model to predict daily location along a smoothing line, from the weighted mean locations. Daily location should be calculated for each year separately.

In the GAM, we can use the weighted mean locations (latitude and longitude) that we have already calculated above. These become the inputs to the gam model, which finds the predicted (smooth) migration path for each day. The predicted (fitted) values become the migration path for the species, which we will then use to estimate start of spring, peak latitude (breeding), and end of autumn migration. Between end Autumn migration and begin of Spring migration, is the expected time that most individual birds are on their wintering grounds and not actively migrating. 


*Creates a dataframe with daily location for each year and graphs results*
#FIXME: use/modify code from migration-path-window to test GAM results using varying k (8-20) and gamma (0-8)
# FIXME: should output a big table of results that we can use to justify our choices and be transparent
```{r}
Estimatedailylocs = function(dat) {

  x <- c(2008:2022)
  spp <- unique(dat$species)

  df_dailylocs <- data.frame(species=character(), day=integer(), year=integer(), month=integer(), winter=character(), lon=numeric(), lat=numeric(), lon_se=numeric(), lat_se=numeric()) #initialize empty dataframe

  for (s in spp){
    for (i in x) {
      sub_weighted_mean_locs <-
        dat %>%
        filter(year == i & species == s)

      lon_gam = gam(weighted_lon ~ s(day, k=20), data = sub_weighted_mean_locs, gamma = 1.5)
      lat_gam = gam(weighted_lat ~ s(day, k=20), data = sub_weighted_mean_locs, gamma = 1.5)
      xpred = data.frame(day=sort(unique(sub_weighted_mean_locs$day)))
      lonpred = predict(lon_gam, newdata = xpred, type="response", se.fit=T)
      latpred = predict(lat_gam, newdata = xpred, type="response", se.fit=T)

      preds =  data.frame(species = s, day = xpred$day, year = i,
                          month = sub_weighted_mean_locs$month, winter = sub_weighted_mean_locs$winter,
                          lon = lonpred$fit, lat = latpred$fit, lon_se = lonpred$se.fit, lat_se = latpred$se.fit)
      df_dailylocs <- data.frame(bind_rows(df_dailylocs, preds))
    }
  }
  return(df_dailylocs)
}

#get daily centroid locations for all species in all years
dailylocs <- Estimatedailylocs(weighted_mean_locs)

#filtering only the migratory species (9 species)
  #Sturnella magna and Sturnus vulgaris are not working (magna not working in 2017, vulgaris not working in 2008) #FIXME: check this note and delete once fixed.
  #Only using 7 species 
spp7dailylocs <- dailylocs %>% filter (species %in% c("Bombycilla cedrorum", "Haemorhous purpureus", "Hylocichla mustelina", "Junco hyemalis", "Setophaga coronata", "Turdus migratorius", "Sialia sialis"))

ggplot(spp7dailylocs, aes(day, lat)) + geom_line(size=1, aes(col=species)) +
  # geom_vline(xintercept=c(101, 209, 362), col="gray30") + #FIXME: Update xintercepts with dates
  geom_vline(xintercept=c(91, 275), col="gray30") +
  facet_wrap( ~ year, ncol=3)+ xlab("Day of Year") + ylab("weighted mean latitude") +
  theme_bw()

ggplot(spp7dailylocs, aes(lon, lat, group=year)) +
  geom_point(aes(col=winter), alpha=0.25) +
  scale_colour_manual(values = c("grey50", "blue")) +
  facet_wrap(~species)

ggplot(spp7dailylocs, aes(lon, lat, group=year)) +
  geom_point(aes(col=winter), alpha=0.25) +
  scale_colour_manual(values = c("grey50", "blue")) +
  facet_grid(year~species)

#FIXME: For relevance to ERC, we have some generic winter months, labeled in blue, but will need to also determine the lat-long of interest. For example, Hylocichla mustelina is definitely migrating during the winter, but much of this may be further south than the main area of interest, and not fully relevant during all of the winter time frame.
```


## Find the distances traveled between the mean locations. 
This calculation uses Great Circle (ellipsoid) distance on the estimated daily locations from the GAM model predictions for latitude and longitude. Because of the way the distVicentyEllipsoid function works on the values, the rows *must* all be in chronological order.
```{r}
#identify dates with no location and assign all values to NA
spp7missdates <- spp7dailylocs %>%
  group_by(species, year) %>%
  #technically this leaves out DAY 366 in 2008, 2012, 2016, and 2020, but I don't think that matters?
  summarize(missing = setdiff(1:365, day)) %>% 
  mutate(day = missing, month=NA, winter=NA, lon=NA, lat=NA, lon_se=NA, lat_se=NA) %>%
  dplyr::select(species, day, year, month, lon, lat, lon_se, lat_se)

#append the missing/NA date values to the main dailylocs dataframe
spp7dailylocs <- bind_rows(spp7dailylocs, spp7missdates)

#calculate sequential distances using geosphere::distVicentyEllipsoid, adds NA for the first record
calc_distances <- function(lon, lat) {
  m <- cbind(lon,lat)
  dist <- append(NA, distVincentyEllipsoid(m))/1000
  return(dist)
}

spp7dailylocs <- spp7dailylocs %>%
  arrange(species, year, day) %>% #order chronologically by year and day
  group_by(species, year) %>%
  #calculate sequential distances, adds NA for the first record
  mutate(distance = calc_distances(lon, lat)) %>%
  #Remove Day 1 for all year; due to our method separating GAM by year, it will be a flawed value
  filter(day != 1)

#saving 7 migratory species of daily location 
# Save an object to a file
#saveRDS(spp7dailylocs, file = "spp7dailylocs.rds")
# Restore the object
#readRDS(file = "spp7dailylocs.rds")

dist_by_day <- ggplot(spp7dailylocs, aes(as.numeric(day), distance, group=year)) + 
  geom_line(aes(col=species)) + 
  theme_bw() + 
  xlab("Julian Day") + ylab("Distance Traveled (km)") + 
  theme(text = element_text(size=12)) + 
  facet_wrap(~species)  
  #geom_vline(xintercept = median(day), col = "indianred", linetype = "dashed")
  #geom_vline(xintercept = median(migr_dates), col = "indianred", linetype = "dashed")

ggsave(dist_by_day, filename = "figs/7species_distances_2023.png", height = 5, width=8)

#FIXME: Is the below note resolved? If yes, then OK to delete.
#TODO: If placed after the dates are calculated, then the speeds used can be limited to the migration seasons using the filter below. Not sure we need to do that here, but I think this is how I got around the year-to-year day 1 being wrong things last time, plus, that project was really only focused on the migration seasons alone.
#  filter(DAY >= migration_dates$spring_begin & migration_dates <= migration_dates$autumn_end)

```

## Estimate the maximum migration speed during migration 
First, remove all values for Day = 1. Because each GAM was calculated separately by year, distance between Dec 31 and Jan 1 will not be valid. 
Use the median of the top 5 migration speeds for each year separately, as the estimated maximum migration speed (km/day) for the species. 
```{r}
#originally dailylocs has 9 colums and spp7dailylcs has 10 columns. In order to run the function, we need to have the same column. 

# function to estimate the maximum speed of migration (km/day)
EstimateMaxSpeed = function(dat) {
  dat <- dat %>%
  filter(day != 1)
  years <- c(2008:2022)
  species <- unique(dat$species)
  # initialize empty dataframe
  df_maxspeed <- data.frame(species=character(), year=integer(), max_speed=integer())
 
   for (s in species){
    for (i in years){
   sub_dailylocs <- 
       spp7dailylocs %>%
       filter(year == i & species == s)
  
    median <- median(tail(sort(sub_dailylocs$distance),5))
    maximum_speed <-  data.frame(species = s, year = i, max_speed = median)
    df_maxspeed <- data.frame(bind_rows(df_maxspeed, maximum_speed))
    }
  }
return(df_maxspeed)
}

#estimate the maximum migration speed for each year
spp7max_speed <- EstimateMaxSpeed(spp7dailylocs)

spp7max_speed

#saveRDS(spp7max_speed, "spp7max_speed.rds")

# #Loading RDS file 
#spp7max_speed <- readRDS("spp7max_speed.rds")

# #showing the table of the migration speed 
# spp7migrationspeedtable<-kbl(spp7max_speed) %>%
#   kable_paper(bootstrap_options = "striped", full_width = F)
# 
# spp7migrationspeedtable
# 
# #exporting the table in txt format 
# write.table(spp7max_speed, file = 'spp7migrationspeedtable.txt', col.names = TRUE,
#              row.names = FALSE, sep = "\t")


# library(gridExtra)
# pdf("data_output.pdf", height=20, width=8.5)
# grid.table(spp7max_speed)
# dev.off()

spp7speeds <- spp7max_speed %>%
  group_by(species) %>%
  summarise(
    mean = mean(max_speed),
    sd = sd(max_speed),
    median = median(max_speed))


# plot yearly maximum migration speeds for each species
max_mig_speed <- ggplot(spp7max_speed, aes(year, max_speed)) + 
  geom_point() +
  #geom_hline(yintercept = med, linetype="dashed", col="hotpink") +
  theme_bw() + 
  xlab("Year") + ylab("Max Speed (km/day)") + 
  theme(text = element_text(size=10), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position="bottom") + 
  scale_x_continuous(breaks=seq(2008, 2022, 3)) +
 # annotate(geom="text", x= 3, y= 50, label=paste0("median = ", round(med,2), " km/day")) + 
  facet_wrap(~species)

ggsave(max_mig_speed, filename = "figs/7species_MedMaxMigrationSpeed_2023.png")

```


# estimate 3 migration dates, beginning of spring, peak latitude (summer), end of fall migration
This will need some editing to work on each year separately. Ideally a resulting data frame with columns for year, begin_spring, peak_latitude, end_autumn

TODO/ #FIXME:need to figure out these two species(why stopping at 2017 and 2008? why other year are working?)
```{r}
#saving S.magna and S.vulgaris data into rds file seperately

#magnadailylocs <- dailylocs %>% filter (species %in% c("Sturnella_magna") )
#vulgarisdailylocs<-dailylocs %>% filter (species %in% c("Sturnus_vulgaris") )

#saveRDS(magnadailylocs, "magnadailylocs.rds")
#saveRDS(vulgarisdailylocs, "vulgarisdailylocs.rds")

#magnadailylocs <- readRDS("magnadailylocs.rds")
#vulgarisdailylocs <- readRDS("vulgarisdailylocs.rds")
```

FIXME/TODO: (Dr. Supp needs to check) double check index dates 
Note: Since 2023 is only half way filled, year of 2023 is excluded in Est3MigrationDates. 
index is finding exact date of the migration date

```{r}
# modified from old function Est3MigrationDates in migration-fxns.R
Est3MigrationDates = function(dat){
  #takes in predicted centroids for migration path, and estimates the beginning of spring migration,
  # the end of fall migration, and the date where the species reaches maximum latitude.
  dat <- dat %>%
  filter(day != 1)
  year <- c(2008:2022)
  species <- unique(dat$species)
  df_dates <- data.frame(species=character(), year=integer(), spring=numeric(), maxlat=numeric(), fall=numeric()) #initialize empty dataframe
  
  for (s in species) {
    for (y in year){
      dat_subset <- 
        dat %>%
        filter(year == y & species == s) %>%
        filter(!is.na(lon))
    print(paste0("species: ", s, "; year: ", y))
    
    #GAM model on predicted latitude of centroids by julian date
    gam1 = gam(lat ~ s(day, k = 40), data = dat, gamma = 1.5)
    xpred = data.frame(day = c(1:max(dat$day)))
    dpred = predict(gam1, newdata=xpred, type="response", se.fit=TRUE)
    
    ## cutoff based on 2 SE for spring and fall combined, following La Sorte et al. 2013 methods
    # Spring migration should be between 11 Jan and 9 July
    # Fall migration should be between 8 August and 21 Dec
    #NOTE: These dates are seeking Jan 1-May 31 for Spring migration begin
    #                 AND          Aug 1-Dec 30 for Fall migration end 
   # CHANGED FROM PREVIOUS CODE FOR HUMMINGBIRD PROJECT
   # ALSO ADDED NA.RM=TRUE ARGUMENT, DOES THIS HAVE ANY DOWNSIDES?
  
    spring_threshold = min(filter(dat_subset, day %in% c(2:120))$lat_se*2.56 + filter(dat_subset, day %in% c(2:120))$lat, na.rm=TRUE) # Jan 2 ~ April 30
    fall_threshold = min(filter(dat_subset, day %in% c(244:364))$lat_se*2.56 + filter(dat_subset, day %in% c(244:364))$lat, na.rm=TRUE) # Oct7 ~ Sep 1 
    
    #FIXME: after removing DAY=1, there are years with 364 days and with 365 days.If we ignore the last day of the leap years, will this influence fall threshold?
    
    spring_index = intersect(c(11:190), dat_subset$day) # between 11 Jan and 9 July #FIXME: what should these dates be, they don't match 
    fall_index = intersect(c(220:355), dat_subset$day) # between 8 August and 21 Dec
    spring_max = (dat_subset %>% filter(day %in% spring_index) %>% slice_max(lat))$day
    fall_max =  (dat_subset %>% filter(day %in% fall_index) %>% slice_max(lat))$day
    
    #identify beginning of spring migration
    tst = 1000
    spring_index2 = spring_max
    while(tst > spring_threshold){
      if(nrow(filter(dat_subset, day==spring_index2))>0) {
        tst = filter(dat_subset, day %in% spring_index2)$lat
        if(spring_index2 == 1) break #see if we have to put 2 
        spring_index2 = spring_index2 - 1
      }
      else { spring_index2 = spring_index2 - 1 }
    }
    spring_begin = spring_index2 + 1
    
    #identify end of fall migration
    tst <- 1000
    fall_index2 = fall_max
    while(tst > fall_threshold){
     # print(paste0("tst= ", tst, " fall_index2= ", fall_index2))
      if(nrow(filter(dat_subset, day==fall_index2))>0) {
        tst = filter(dat_subset, day==fall_index2)$lat
        if(fall_index2 == 1) break
        fall_index2 = fall_index2 + 1
      }
      else { fall_index2 = fall_index2 + 1 }
    }
    fall_end <- fall_index2 - 1
    
    # find center of the season, max latitude (e.g. population no longer moving north; breeding)
    max_lat = dat_subset[dat_subset$lat == max(dat_subset$lat),]$day
    dates = data.frame(species = s, year = y, spring = spring_begin, maxlat = max_lat, fall = fall_end)
    df_dates <- data.frame(bind_rows(df_dates, dates))
    }
  }
return(df_dates)
}

spp7MigrationDates <- Est3MigrationDates(spp7dailylocs)
#saveRDS(spp7MigrationDates, "spp7MigrationDates_2023.rds")
```


```{r}
#spp7MigrationDates <- readRDS("spp7MigrationDates.rds")

median_migdates <- spp7MigrationDates %>%
  group_by(species) %>%
  summarise(begin_winter = median(fall),
            end_winter = median(spring))

#paste0("The beginning of winter is on average day ", begin_winter, " and the end of winter is on average day ", end_winter, ".")

begin <- ggplot(spp7MigrationDates, aes(year, fall)) + 
  geom_point() + 
  geom_smooth(method="lm") +
  #geom_hline(yintercept = begin_winter, linetype="dashed", col="hotpink") +
  theme_bw() + xlab("Year") + ylab("Winter begin date") + 
  theme(text = element_text(size=9), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks=seq(2008, 2021, 2)) +
 # annotate(geom="text", x= 2012, y= 340, label=paste0("median doy = ", round(begin_winter,2)))
  facet_wrap(~species)

end <- ggplot(spp7MigrationDates, aes(year, spring)) + 
  geom_point() + 
  geom_smooth(method="lm") +
 # geom_hline(yintercept = end_winter, linetype="dashed", col="hotpink") +
  theme_bw() + xlab("Year") + ylab("Winter end date") + 
  theme(text = element_text(size=9), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +  
  scale_x_continuous(breaks=seq(2008, 2021, 2)) +
  #annotate(geom="text", x= 2012, y= 55, label=paste0("median doy = ", round(end_winter,2)))
  facet_wrap(~species)

ggarrange(begin, end,
          labels=c("Begining of the winter", "End of the winter"),
          ncol=2, nrow=1)

ggsave(filename = "figs/7spp_MigrationDates_2023.png", height = 10, width=10)
```

# Statistically compare migration paths, speeds, and dates across the time-series for each species

Look at linear trends for dates of the 7 migratory species to see if there is a significant directional trend, or not.
```{r}
# Function to extract relevant statistics from linear regression object
extract_lm_stats <- function(model) {
  summary_model <- summary(model)
  
  tidy_model <- broom::tidy(model) %>% 
    filter(term == "year")
  
  tibble(r2 = summary_model$r.squared,
    estimate = tidy_model$estimate,
    conf_low = tidy_model$conf.low,
    conf_high = tidy_model$conf.high,
    pvalue = tidy_model$p.value)
}


# Apply the function to each species for spring and fall, separately
date_results <- spp7MigrationDates %>%
  group_by(species) %>%
  summarize( spring_lm = list(lm(spring ~ year, data = cur_data())),
    fall_lm = list(lm(fall ~ year, data = cur_data())) ) %>%
  mutate( spring_stats = map(spring_lm, extract_lm_stats),
    fall_stats = map(fall_lm, extract_lm_stats) ) %>%
  select(-spring_lm, -fall_lm) %>% # Remove the models if not needed
  unnest(cols = c(spring_stats, fall_stats))

# View results
date_results

# FIXME: Previously was repeated code for each species like that commented out below. 
#   Delete after testing if the above solution works. 

# cedrorum <- spp7MigrationDates %>%
#   filter(species=="Bombycilla cedrorum")
# 
# #linear regression for spring 
# cedrorum_spring <- lm(spring ~ year, data=cedrorum)
# #summary(cedrorum_spring)
# 
# #linear regression for fall
# cedrorum_fall <- lm(fall ~ year, data=cedrorum)
# #summary(cedrorum_fall)

# #FIXME: If the above chunk works, then can delete below, or modify to use on date_results df
#   Ideally, we provide a nice table that shares the results from the fall and spring migration dates
#   In other words: are the onset and end of migration temporally stable over the past 15 years, or changing?
# FIXME: If the below code is not kept, remove library(stargazer) from the start of the code.

#making linear regression result table for fall ()
# stargazer(cedrorum_fall, coronata_fall, migratorius_fall, mustelina_fall, purpureus_fall, hyemalis_fall, sialis_fall, type = "text",  
#      title = "Fall Migration Species Directional Changes",out="figs/Fall Migration Species Directional Changes.txt", column.labels=c("B.cedrorum","S.coronata","T.migratorius", "H.mustelina","H.purpureus","J.hyemalis","S.sialis"), covariate.labels = c("year", "Intercept"), report = "vcp*")

```


Now we just want to look at bird occurrences during the winter months, and in the latitudes that ERC occur in: 
Can use the winter column to grab all data October-March and the latitudes ~ 26-47 --Note that these choices are somewhat arbitrary, just to get a quick look now. Will need to get finer grained info from D. Ward and lab later...
```{r}
ERCbirds <- spp7dailylocs %>%
  filter(lat - lat_se > 27 & lat + lat_se < 47 & winter=="winter")

ggplot() + 
  geom_polygon(data=state_prov, aes(x=long, y=lat, group = group), colour="grey50", fill="white") + 
  geom_point(data=ERCbirds, aes(lon, lat, col=species), size=.1) + 
  xlim(-102,-52) + 
  ylim(25,50) +
  theme_bw() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
  facet_wrap(~month)

```

# look at the dat_effort file locations, not just the daily locs (which are summarized centroids only)
```{r}
 spp7 <- df %>% filter (species %in% c("Bombycilla_cedrorum", "Haemorhous_purpureus", "Hylocichla_mustelina", "Junco_hyemalis", "Setophaga_coronata", "Turdus_migratorius", "Sialia_sialis") )

winter_dat_effort <- spp7 %>%
  mutate(DAYm1 = day-1,
         origin = paste0(year, "-01-01"),
         date = as.Date(DAYm1, origin=origin),
         month = month(date)) %>%
  mutate(winter = ifelse(month %in% c(10, 11, 12, 1, 2, 3), "winter", "non-winter")) %>%
  arrange(species,date) %>%
  ungroup() %>%
  mutate(ID = row_number()) %>%
  dplyr::select(-DAYm1, -origin) %>%
  filter(winter=="winter") %>%
  filter(y > 27 & x < 47)


  ggplot() + 
  geom_polygon(data=state_prov, aes(x=long, y=lat, group = group), colour="grey50", fill="white") + 
  geom_point(data=winter_dat_effort, aes(x, y, col=species), alpha=.2, size=.1) + 
  xlim(-102,-52) + 
  theme_bw() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
  facet_grid(species~month)
```


#--------------------------------------------------
#Start spatial analysis... 

Now, try to summarize the number of unique species in each POLYFID on each day in each year for the winter ERC season (can be counted as nrow())
```{r}
sppR <- winter_dat_effort %>%
  group_by(cell, cell_lat, cell_lon, year, month, day) %>%
  summarize(num_spp = n())

# sppR <- dat_effort %>%
#     mutate(DAYm1 = DAY-1,
#          origin = paste0(YEAR, "-01-01"),
#          DATE = as.Date(DAYm1, origin=origin), 
#          MONTH = month(DATE)) %>%
#   group_by(POLYFID, YEAR, MONTH, DAY) %>%
#   summarize(num_spp = n())

ggplot(sppR, aes(as.factor(num_spp), cell_lat)) + geom_boxplot() + 
  facet_wrap(~year)
ggplot(sppR, aes(as.factor(num_spp), cell_lon)) + geom_boxplot() + 
  facet_wrap(~year)

avg<- sppR %>%
  group_by(year, month) %>%
  summarize(mean = mean(num_spp), 
            median = median(num_spp))

avg2 <- sppR %>%
  group_by(year, month, day) %>%
  summarize(mean = mean(num_spp),
            median = median(num_spp))

ggplot(sppR, aes(day, num_spp)) + 
  geom_boxplot() + 
  facet_wrap(~month)

ggplot(avg, aes(year, mean)) + geom_point() + facet_wrap(~month)
mod2 <- lm(mean~as.numeric(year), data=avg)
summary(mod2)

ggplot(avg, aes(mean)) + geom_histogram(aes(fill=year)) + facet_wrap(~month)

ggplot(avg, aes(year, median)) + geom_point() + facet_wrap(~month)

ggplot(avg2, aes(day, mean)) + geom_point() + facet_grid(year~month, scale="free")


```

Calculate the number of species in a hex cell for each month (as opposed to day). Save as a table and then plot it on the grid cell map, using viridis color scale.
```{r}
sppR_mo <- sppR %>%
  group_by(cell, cell_lat, cell_lon, year, month) %>%
  summarise(Smed=median(num_spp), 
            Smax=max(num_spp),
            Smin=min(num_spp))

#Get the grid cell boundaries for cells which had bird observations
grid <- dgcellstogrid(dgg, sppR_mo$cell, frame=TRUE, wrapcells=TRUE)
#grid <- dgcellstogrid(dgg, sppR_mo$cell)

#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, sppR_mo, by.x="cell", by.y="cell")

#zoom to just eastern USA
grid <- grid %>%
  filter(long >= -103,
         lat >= 25)
#Get polygons for the spatial range and make a map of bird observations
countries <- map_data("usa") 

grid2019 <- grid %>% filter(YEAR ==20222)

#plot just 2019, median values for the month
ggplot() + 
  #geom_polygon(data=countries, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  geom_polygon(data=grid2019, aes(x=long, y=lat, group=cell, fill=Smed), alpha=1)    +
  geom_path   (data=grid2019, aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
#  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
  #scale_fill_gradient(low="gray90", high="black") + 
  scale_fill_viridis() +
  #scale_fill_gradient2(low="blue", high="red", midpoint = 250) 
  theme_void() + 
  facet_wrap(~MONTH)

ggsave("figs/winter2019.png", bg="transparent", height=7, width=11)

```

Calculate the slopes of species richness change across years, within cells. Plot the results to see if there is a trend of higher species disperser load through time. Need to think and check with FAL for ideas to see if we need to account for overall effort better (currently using as pres-only data, without weighted checks)
```{r}
# look at the structure of sppR_mo

cells <- unique(sppR_mo$cell)
months <- c(10, 11, 12, 1, 2, 3)
df_sppR <- data.frame(cell=numeric(), month=integer(), n=integer(), slope=numeric(), pVal=numeric(), cell_lat=numeric(), cell_lon=numeric()) #initialize empty dataframe

for (c in cells){
  dat <- sppR_mo %>% filter(cell == c)
  for (m in months){
    dat2 <- dat %>% filter(month == m)
    if (nrow(dat2) >= 3) {
      mod <- lm(Smed~as.numeric(year), data=dat2)
      n = nrow(dat2)
      slope = coef(mod)[[2]]
      pVal = glance(mod)$p.value[[1]]
      cell_lat = dat2$cell_lat[1]
      cell_lon = dat2$cell_lon[1]
      
      df_sppR <- rbind(df_sppR, c(c, m, n, slope, pVal, cell_lat, cell_lon))
    }
  }
}
#remove the NA values
#FIXME: are we dropping all the rows that has NA values? does sig = pValue? 
  # previously had this filter: filter(!is.na(sig)); FIXME: delete if no longer need this note
na.omit(df_sppR )
  
# adding factor names and levels to month, ordered by winter season, not calendar year
df_sppR$monthname <- month(as.numeric(df_sppR$month), label=TRUE)
df_sppR$monthname <- factor(df_sppR$monthname, levels=c("Oct", "Nov", "Dec", "Jan", "Feb", "Mar"))

# add column for significance
df_sppR$sig <- ifelse(df_sppR$pVal < 0.05, "sig", "NS")
  
#ggplot histogram, layered by identity for sig and NS
ggplot(df_sppR, aes(slope)) + 
  geom_histogram(aes(fill=sig), position="identity", alpha=0.5) +
  scale_fill_manual(values = c("gray", "darkturquoise")) + 
  geom_vline(xintercept=0, linetype="dashed", col="gray50") +
  theme_bw()

# ggplot boxplot by month for all significant slopes, commented code shows month comparisons, not currently included in figure
ggplot(df_sppR %>% filter(sig=="sig"), aes(monthname, slope)) + 
  geom_boxplot(fill="black", col="black", notch=TRUE) +
  geom_jitter(col="cyan3", alpha=0.5) +
  geom_hline(yintercept=0, linetype="dashed", col="black") +
  xlab("") +
  ylab("slope") +
#  stat_compare_means(method="wilcox.test", comparisons = list(c("Oct", "Nov"), c("Oct", "Jan"), c("Oct", "Feb"))) +
#  stat_compare_means(label = "p.signif", method = "t.test", ref.group = 1, hide.ns=TRUE) +
    theme(
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.text.y = element_text(colour="black", size=14),
        axis.title.y = element_text(colour="black", size=14)
        ) 
  #add significance, only difs were oct-nov, oct-jan, oct-feb
  # add text labels for mean slopes?

# Figure for ESA 2021 poster
#ggsave("figs/Smed_slopes_month.png", bg="transparent", height=3, width=11)

#average effect size, mean of the slopes
df_sppR %>% 
  filter(sig=="sig") %>%
#  group_by(monthname) %>%
  summarize(meanslope = mean(slope),
            medianslope = median(slope))

#plot by latitude? any signal here?
ggplot(df_sppR %>% filter(sig=="sig"), aes(cell_lat, slope)) + 
  geom_point(alpha=0.10) + 
  geom_hline(yintercept=0, linetype="dashed") +
  geom_smooth(method="lm") + 
  facet_wrap(~monthname)

# Figure for ESA 2021 poster
#ggsave("figs/sig_slopes_month_lat.png", bg="transparent", height=4, width=6)

# ggplot boxplot by month for all slopes, shaded jitter points by sig
ggplot(df_sppR, aes(monthname, slope)) + 
  geom_boxplot(fill="black", col="black", notch=TRUE) +
  geom_jitter(aes(col=sig), alpha=0.5) +
  scale_colour_manual(values=c("gray", "cyan3")) +
  geom_hline(yintercept=0, linetype="dashed", col="black") +
  xlab("") +
  ylab("slope") +
    theme(
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.text.y = element_text(colour="black", size=14),
        axis.title.y = element_text(colour="black", size=14)
        ) 

#some basic t.tests to show that all slopes (sig and sig+NS) were significantly different from Zero, and significantly positive (very few with lower richness through time) -- correlate to higher potential disperser load over the past decade -- could imply an increasing role for dispersers, but need to discuss with Frank what else we'd need to check to ensure that this isn't just due to increasing eBird effort (In retrospect I may not have yet controlled well for this, or need to use the weighted measures instead of presence only directly?)

```



Let's plot the map using the significant slopes, and all others shaded in grey
```{r}
#Get the grid cell boundaries for cells which had bird observations
grid <- dgcellstogrid(dgg, df$cell, frame=TRUE, wrapcells=TRUE)

#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, df, by.x="cell", by.y="cell")
#zoom to just eastern USA
grid <- grid %>%
  filter(long >= -103,
         lat >= 25)
#Get polygons for the spatial range and make a map of bird observations
countries <- map_data("usa") 

gridsig <- grid %>% filter(sig == "sig")
gridNS <- grid %>% filter(sig == "NS")

#plot significant values by viridis shades, nonsignificant values as grey
ggplot() + 
 # geom_polygon(data=countries, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  geom_polygon(data=gridsig, aes(x=long, y=lat, group=cell, fill=slope))    +
  geom_path   (data=gridsig, aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
#  geom_point  (aes(x=cellcenters$lon_deg, y=cellcenters$lat_deg), size=0.5) +
  #scale_fill_gradient(low="gray90", high="black") + 
  # scale_fill_viridis() +
  scale_fill_gradient2(low="navyblue", high="firebrick3", midpoint = 0) +
  geom_polygon(data=gridNS, aes(x=long, y=lat, group=cell), fill="grey") +
  #geom_path   (data=gridNS, aes(x=long, y=lat, group=cell), alpha=0.4, color="white") +
  theme_void() + 
  facet_wrap(~monthname, nrow=1) + 
  theme(legend.position = "left")

ggsave("figs/slope_Smed_change.png", bg="transparent", height=3.5, width=16)
```




#Little's range and FIA importance value species distribution map for Eastern red cedar
Try something with a shapefile
Downloaded this one for eastern red cedar from https://www.fs.fed.us/nrs/atlas/littlefia/species_table.html  
```{r}
#found some useful help here: https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/intro-to-coordinate-reference-systems/ 
#may also be useful to read thorugh here: https://geocompr.robinlovelace.net/reproj-geo-data.html 

# read shapefile
ERC <- readOGR(dsn = paste0(here(), "/data/shapefile/litt68av.shp"))
# convert to dataframe
ERC_df <- fortify(ERC)

# plot map using ggplot
ERCmap <- ggplot(ERC_df, aes(long,lat, group = group)) +
  geom_polygon(fill="darkolivegreen") +
  coord_equal() +
  labs(x = "Longitude (Degrees)",
       y = "Latitude (Degrees)",
      title = "ERC Range Map",
      subtitle = "D_Clarke_1866 Datum, Projection: Albers, Units: Degrees - Lat / Lon") + 
  theme_void()
ERCmap

# Figure for ESA 2021 poster
ggsave("ERC_range.png", ERCmap, bg="transparent")

#TODO reprojection of the range data is needed, or transformation of all other data including points to Albers, or it won't work.
# reproject data from Albers to WGS84 CRS
ERC_WGS84 = sf::st_transform(ERC, crs = "+proj=wgs84") #FIXME
ERC_WGS84 <- sp::spTransform(ERC,
                                CRS("+proj=wgs84")) #FIXME

# grab winter locations from the winter_dat_effort dataframe
# add a point to the map
mapLocations <- ERCmap +
                geom_point(data = winter_dat_effort,
                aes(x = lon, y = lat, group = NULL), colour = "orange",
                      size = .5)
mapLocations



--------------------------------
#FIXME: Error in ogrInfo(dsn = dsn, layer = layer, encoding = encoding, use_iconv = use_iconv,  : Cannot open data source
my_spdf <- readOGR( 
  dsn=paste0(here(), "/data/shapefile2/") , 
  layer="litt68av",
  verbose=FALSE
)

#explore the shapefile
summary(my_spdf)
length(my_spdf)
head(my_spdf@data)

# Basic plot of this shape file using Base R:
par(mar=c(0,0,0,0))
plot(my_spdf2, col="darkolivegreen", bg="grey80", lwd=0.25, border=0 )

# 'fortify' the data to get a dataframe format required by ggplot2
require(broom)
spdf_formytified <- tidy(my_spdf, region = "LITT68_ID")

# reproject data
spdf_WGS84 <- rgdal::spTransform(my_spdf,
                                crs(state_prov))

# get background map layers
state_prov <- rnaturalearth::ne_states(c("united states of america", "canada"))
us  <- map_data("usa")

# Plot it using ggplot2, just a shape, no context. Seems to be missing projection ?? Can't add points or background map.
ggplot() + 
  geom_polygon(data = spdf_fortified, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white", alpha=0.25) +
  theme_void()

#TODO: Can't plot the shapefile onto the map because it isn't the right projection
#       sf should be abel to help this, maybe here? https://r-spatial.org/r/2018/10/25/ggplot2-sf-2.html 
ggplot(data = world) +
  geom_sf() + 
  geom_point(data=dat_effort, aes(x=lon, y=lat), size=0.2) + 
  coord_sf(xlim = c(-103, -48), ylim = c(24.5, 60), expand = FALSE) +
 #geom_polygon(data = spdf_fortified, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white", alpha=0.25) +
  theme_void()
  
```


