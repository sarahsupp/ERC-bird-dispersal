---
title: "BBL Summary Statistics"
author: "Maximilian Wisnefski"
date: '2023-06-02'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(tidyr)
library(sf)
library(sfheaders)
library(rnaturalearth)
#devtools::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)
```


## Introduction and read in the Bird Banding Laboratory datasets

In this .rmd, I am using the filtered BBL data to learn about the movement of individual banded birds for the 15 species of interest. I'm also making some basic visuals describing the data.

Here, we read in the data and filter out non-target species and subspecies

```{r}
#this data has been filtered using lats/lons of ERC shapefile
#BBL_all <- readRDS("data_2023/BBL_data/BBL_in_range_2022.rds")

#this data has not been filtered
BBL_all <- readRDS("data_2023/BBL_data/BBL2022.rds")

#converting dataframe from sf object to normal df
#BBL_all <- sf_to_df(BBL_all, fill = TRUE, unlist = NULL)
#BBL_all = subset(BBL_all, select = -c(sfg_id,x,y) )
BBL_all$species_name <-tolower(BBL_all$species_name)

#check the species names
unique(BBL_all$species_scientific_name)

#remove western subspecies and an incorrect species
BBL_all <- BBL_all %>%
  filter(!species_scientific_name %in% c("Junco hyemalis oreganus", "Setophaga coronata auduboni", "Setophaga petechia"))
```

In the next step, we create a subset of the data that only includes banding events.
```{r}
#filtering to just banding events, not encounters (since encounters all overlap with bandings)
#rows with event type B also have consistent names for the different species
just_banding <- BBL_all[BBL_all$event_type == 'B',]
```

Let's count all the individual birds that were banded
```{r}
# check that all the species appear to be present in this dataset, and create a vector of names
birds <- unique(just_banding$species_scientific_name)

# let's look at it as a table to see the counts
table(just_banding$species_scientific_name)

# summarize the counts in a table
bird_count <- BBL_all %>%
  group_by(species_scientific_name) %>%
  summarize(n())
```

```{r}
ggplot(bird_df, aes(x=species_name, y=count)) +
  geom_bar(stat="identity") + 
  ggtitle("Counts for Each Bird for all years (1960-2022)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),plot.title = element_text(hjust = 0.5))
```

```{r}
#should probably also get rid of 2022 since there is not data for full year
BBL_recent <- BBL_all[BBL_all$event_year >= 2008,]
just_banding_recent <- just_banding[just_banding$event_year >= 2008, ]

#getting counts for each bird
#probably could have just used a groupby, but this was the first way I thought to do it
birds <- unique(just_banding$species_name)
bird_counts <- list()
for (b in birds){
  count <- length(which(BBL_recent$species_name == b))
  bird_counts <- append(bird_counts, count)
}

bird_df_recent = data.frame(unlist(birds),unlist(bird_counts))
names(bird_df_recent) = c("species_name","count")
```


```{r}
ggplot(bird_df_recent, aes(x=species_name, y=count)) +
  geom_bar(stat="identity") + 
  ggtitle("Counts for Each Bird (2008-2022)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),plot.title = element_text(hjust = 0.5))
```


```{r}
#used a groupby this time
#grouping by year and species
BBL_year_count <- just_banding %>% group_by(species_name, event_year) %>% 
  summarise(total_count=n(),.groups = 'drop') %>%
  as.data.frame()
```


```{r}
ggplot(BBL_year_count, aes(x = event_year, y = total_count)) + 
  geom_line(aes(color = species_name)) + 
  #scale_color_manual(values = c()) +   #might change line colors later  
  ggtitle("Change in number of species records each year (1960-2022)") +
  xlim(1960, 2021)
```


```{r}
#grouping by year and species for just more recent years
#using just_banding_recent because it has consistent names for all species, so the groupby actually works
BBL_year_count_recent <- just_banding_recent %>% group_by(species_name, event_year) %>% 
  summarise(total_count=n(),.groups = 'drop') %>%
  as.data.frame()
```


```{r}
ggplot(BBL_year_count_recent, aes(x = event_year, y = total_count)) + 
  geom_line(aes(color = species_name)) + 
  #scale_color_manual(values = c()) +   #might change line colors later  
  ggtitle("Change in number of species records each year (2008-2022)") +
  xlim(2008, 2021)
```


```{r}
#grouping by original band and species for all years
BBL_unique_1960 <- BBL_all %>% group_by(species_name, original_band) %>% 
  summarise(total_count=n(), .groups = 'drop') %>%
  as.data.frame()

#filtering for just unique birds that were found more than once 
unique_mult_1960 <- BBL_unique_1960[BBL_unique_1960$total_count >= 2, ]
```


```{r}
#grouping by original band and species for recent years (2008-2022)
BBL_unique_recent <- BBL_recent %>% group_by(species_name, original_band) %>% 
  summarise(total_count=n(), .groups = 'drop') %>%
  as.data.frame()

#filtering for just unique birds that were captured more than once 
unique_mult_recent <- BBL_unique_recent[BBL_unique_recent$total_count >= 2, ]

#getting list of original bands that have 2 or more captures
capture_mult <- as.list(unique_mult_recent$original_band)

#filtering for just those bands
BBL_unique_mult_recent <- BBL_recent[BBL_recent$original_band %in% capture_mult, ]
```


```{r}
#getting number of recaptures per month for each species
#also includes original capture 
for (b in birds){
  df <- BBL_unique_mult_recent[BBL_unique_mult_recent$species_name == b, ]
  #df$event_month<-as.factor(df$event_month)
  print(ggplot(df, aes(x = event_month)) +
    xlim(1,12) +
    ggtitle(b, "number of recaptures each month (2008-2022)") +
    xlab("encounter month") +
    geom_histogram(bins = 12) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))) 
}
```



```{r}
#grouping previous df by unique lons and lats, as well as original id
#trying to see if any of these birds are being recaptured at different locations
unique_loc <- BBL_unique_mult_recent %>% group_by(lon, lat, original_band) %>% 
  summarise(total_count=n(), .groups = 'drop') %>%
  as.data.frame()

#this ensures that we are excluding recaptures that happened at the exact same location as the original capture
locs <- unique_loc[unique_loc$total_count == 1, ]
list_locs <- as.list(locs$original_band)

recap_diff_locs <- BBL_recent[BBL_recent$original_band %in% list_locs, ]
```

^ this shows that there are, in fact, some recaptures that happen at different locations than the original, but as far as I can tell, many of these recaptures are still really close to each other


```{r}
#making map of range that I am interested in
state_prov <- rnaturalearth::ne_states(c("united states of america", "canada", "mexico", "honduras", "el salvador", "guatemala", "costa rica"), returnclass = "sf")
#state_prov <- st_crop(state_prov, xmin = -115, xmax = -50, ymin = 5, ymax = 50)
state_prov <- st_crop(state_prov, xmin = -140, xmax = -50, ymin = 5, ymax = 60)

```


```{r}
#mapping the movements of recpatured individuals 
i = 1 
for (b in sci_birds){
  #these next two lines are so I can also include common name on map
  name = birds[i]
  i = i + 1

  df <- recap_diff_locs[recap_diff_locs$species_scientific_name == b, ]
  df <- df[df$lat != 0.0, ] 
  
  #setting color to original_band because each original band represents an individual bird
  print(ggplot() + 
    geom_sf(data=state_prov, colour="grey50", fill="white") + 
    geom_path(data = df, aes(x = lon, y = lat, color = original_band), 
              size = 1, lineend = "round") +
    labs(x = " ", y = " ", title = b, subtitle = name) +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5), 
          plot.subtitle = element_text(hjust = 0.5)))
}

```




```{r}
#calculating the earliest and latest month that each species was encountered within the ERC range
#earliest month is mostly Jan and latest is mostly Dec. 
#(results could be different for eBird data)
min_months <- aggregate(BBL_recent$event_month, list(BBL_recent$species_scientific_name), FUN = min)
max_months <- aggregate(BBL_recent$event_month, list(BBL_recent$species_scientific_name), FUN = max)
```


